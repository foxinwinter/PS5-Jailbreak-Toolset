# core/exploits/Y2JB.py
# Copyright (c) 2026 foxinwinter
# Licensed under GPLv3. See Extra/Licenses/LICENSE

import os
import sys
import socket
import subprocess
import time
import platform
import re

SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
BASE_DIR = os.path.dirname(os.path.dirname(SCRIPT_DIR))
CONFIG_DIR = os.path.join(SCRIPT_DIR, ".config", "Y2JB")
CONFIG_FILE = os.path.join(CONFIG_DIR, "ps5_config.txt")
LOG_FILE = os.path.join(CONFIG_DIR, "log_server.log")

os.makedirs(CONFIG_DIR, exist_ok=True)

TOOLS_DIR = os.path.join(BASE_DIR, "Tools", "Y2JB")
PAYLOAD_SENDER = os.path.join(TOOLS_DIR, "payload_sender.py")
LOG_SERVER = os.path.join(TOOLS_DIR, "log_server.py")
SETLOGSERVER_JS = os.path.join(BASE_DIR, "payloads", "Y2JB", "setlogserver.js")
PS5_HEURISTIC_JS = os.path.join(BASE_DIR, "payloads", "Main", "PS5_Heuristic.js")
LAPSE_JS = os.path.join(BASE_DIR, "payloads", "Y2JB", "lapse.js")

DEFAULT_PORT = 50000


class Y2JB:
    def __init__(self, config_dir=None):
        if config_dir:
            self.config_dir = config_dir
        else:
            self.config_dir = CONFIG_DIR
        self.config_file = os.path.join(self.config_dir, "ps5_config.txt")
        self.log_file = os.path.join(self.config_dir, "log_server.log")
        self.payload_sender = PAYLOAD_SENDER
        self.log_server = LOG_SERVER

    def get_local_ip(self):
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        try:
            s.connect(("8.8.8.8", 80))
            ip = s.getsockname()[0]
        except Exception:
            ip = "127.0.0.1"
        finally:
            s.close()
        return ip

    def read_ps5_config(self):
        if not os.path.exists(self.config_file):
            return None, None
        with open(self.config_file, "r") as f:
            lines = f.read().strip().split("\n")
        ip = None
        port = DEFAULT_PORT
        for line in lines:
            if line.startswith("IP:"):
                ip = line.split(":", 1)[1].strip()
            elif line.startswith("PORT:"):
                port = int(line.split(":", 1)[1].strip())
        return ip, port

    def write_ps5_config(self, ip, port):
        with open(self.config_file, "w") as f:
            f.write(f"IP:{ip}\n")
            f.write(f"PORT:{port}\n")

    def ask_ps5_config(self):
        print("Enter PS5 IP address: ", end="")
        ip = input().strip()
        print("Enter PS5 port (default 50000): ", end="")
        port_input = input().strip()
        port = int(port_input) if port_input else DEFAULT_PORT
        self.write_ps5_config(ip, port)
        return ip, port

    def modify_setlogserver_js(self, ip):
        with open(SETLOGSERVER_JS, "r") as f:
            content = f.read()

        new_server = f'"http://{ip}:8080/log"'

        content = re.sub(
            r"LOG_SERVER\s*=\s*[\"'].*?[\"']", f"LOG_SERVER = {new_server}", content
        )

        modified_path = SETLOGSERVER_JS + ".tmp"
        with open(modified_path, "w") as f:
            f.write(content)
        return modified_path

    def send_payload(self, file_path, host, port=DEFAULT_PORT):
        with open(file_path, "rb") as f:
            data = f.read()

        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.connect((host, port))
        sock.sendall(data)
        sock.close()
        print(f"Sent {len(data)} bytes to {host}:{port}")

    def ask_firewall_permission(self):
        system = platform.system()
        if system == "Linux":
            print("\n[!] You may need to allow incoming traffic on port 8080.")
            print("    Run: sudo ufw allow 8080/tcp")
            response = input("    Allow now? (y/n): ").strip().lower()
            if response == "y":
                subprocess.run(["sudo", "ufw", "allow", "8080/tcp"], check=False)
                print("    Port 8080 allowed.")
        elif system == "Windows":
            print("\n[!] You may need to allow Python through Windows Firewall.")
            print("    Allow python.exe in Windows Firewall when prompted.")
            input("    Press Enter after allowing...")

    def wait_for_fw_version(self, timeout=60):
        print(f"Waiting for FW_VERSION from log server (timeout: {timeout}s)...")
        start = time.time()
        while time.time() - start < timeout:
            if os.path.exists(self.log_file):
                with open(self.log_file, "r") as f:
                    content = f.read()
                if "FW_VERSION:" in content:
                    for line in content.split("\n"):
                        if "FW_VERSION:" in line:
                            version_str = line.split("FW_VERSION:", 1)[1].strip()
                            return version_str
            time.sleep(1)
        return None

    def parse_fw_version(self, version_str):
        try:
            parts = version_str.split(".")
            major = int(parts[0])
            minor = int(parts[1]) if len(parts) > 1 else 0
            return major * 100 + minor
        except:
            return 999

    def run(self, config_override=False):
        print("=== PS5 Jailbreak Toolset - Y2JB ===\n")

        local_ip = self.get_local_ip()
        print(f"Local IP: {local_ip}")

        print("\nStarting log server in background...")
        with open(self.log_file, "w") as logf:
            proc = subprocess.Popen(
                [sys.executable, self.log_server], stdout=logf, stderr=subprocess.STDOUT
            )
        time.sleep(2)
        print(f"Log server running (PID: {proc.pid})")

        if config_override or not os.path.exists(self.config_file):
            ps5_ip, ps5_port = self.ask_ps5_config()
        else:
            ps5_ip, ps5_port = self.read_ps5_config()
        if ps5_ip is None or ps5_port is None:
            ps5_ip, ps5_port = self.ask_ps5_config()
        else:
            ps5_port = ps5_port if ps5_port else DEFAULT_PORT
            print(f"Using saved PS5 config: {ps5_ip}:{ps5_port}")

        print("\n--- Firewall Notice ---")
        self.ask_firewall_permission()

        print("\nModifying setlogserver.js...")
        modified_setlogserver = self.modify_setlogserver_js(local_ip)

        print(f"\nSending setlogserver.js to {ps5_ip}:{ps5_port}...")
        self.send_payload(modified_setlogserver, ps5_ip, ps5_port)

        print(f"Sending PS5_Heuristic.js to {ps5_ip}:{ps5_port}...")
        self.send_payload(PS5_HEURISTIC_JS, ps5_ip, ps5_port)

        print("\nWaiting for PS5 to respond with FW_VERSION...")
        fw_version = self.wait_for_fw_version()

        if fw_version is None:
            print("ERROR: Timeout waiting for FW_VERSION from PS5")
            proc.terminate()
            sys.exit(1)

        print(f"Detected FW_VERSION: {fw_version}")

        fw_num = self.parse_fw_version(fw_version)
        if fw_num > 1001:
            print("\nlapse.js cannot be run on FW Versions higher than 10.01")
            print("Stopping here.")
            proc.terminate()
            sys.exit(0)

        print(f"\nSending lapse.js to {ps5_ip}:{ps5_port}...")
        self.send_payload(LAPSE_JS, ps5_ip, ps5_port)

        print("\n=== All payloads sent successfully ===")
        proc.terminate()
